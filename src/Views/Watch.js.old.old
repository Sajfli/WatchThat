import { useState, useRef, useEffect } from 'react'
import ky from 'ky'
import URL from 'url-parse'

import useSocket from 'hooks/useSocket'

// utils
import isURL from 'validator/lib/isURL'
// import { getUsername } from 'services/getUserData'

// hooks
import useLocalisation from 'hooks/useLocalisation'

// UI components
import Player from 'components/organisms/Player/Player'
import TextInput from 'components/atoms/Input/Input'

// style
import style from './Watch.module.scss'
import { useHistory, useParams } from 'react-router'
import useAuth from 'hooks/useAuth'


const Watch = () => {

    const l = useLocalisation()
    const playerContainer = useRef(null)

    const history = useHistory()
    const params = useParams()
    // const socket = useContext(SocketContext)

    const { socket, connect } = useSocket()

    const auth = useAuth()
    // const [ room, setRoom ] = useState(null)

    // video data
    const [ video, setVideo ] = useState({})

    // text input value
    const [ search, setSearch ] = useState('')

    // const playerRef = useRef({})

    useEffect(() => {

        // if(!socket || !socket.connected)
        //     socketConnect()

        if(!params.id || !socket) {
            return history.push('/')
        }

        // if(!params.id || !socket || !socket.connected) {
        //     console.log(socket)
        //     console.log(params.id)
        //     return history.push('/')
        // }

        // if(!socket || !socket.connected) return

        const username = auth.user || localStorage.getItem('tempUsername')


        if(!username)
            return alert('brak username!')


        socket.emit('room join', {roomId: params.id, username})

        // handle room joined event
        socket.on('room joined', roomId => {
            console.log('you have joined the room', roomId)
        })

        // when a new user connect to the room
        socket.on('user connected', username => {
            console.log(username + ' connected to the room')
        })
        socket.on('user disconnected', username => {
            console.log(username + ' disconnected from the room')
        })

        // handle new video from other user in room
        socket.on('new video', data => {
            setVideo(data)
        })

        socket.io.on('reconnection_attempt', () => {
            console.log("reconnection_attempt")
        })

        socket.io.on('reconnect', () => {
            console.log("reconnect")
        })

        socket.on('connect', () => {
            console.log('connect')
        })

        socket.on('disconnect', () => {
            console.log('disconnect')
        })

        // socket.on('get watchtime', () => {
        //     // socket.emit('send watchtime', {video, })
        //     if(playerRef.current) {

        //         const { playing, progress } = playerRef.current

        //         socket.emit('send watchtime', {video, state: {
        //             playing, progress
        //         }})
        //     }

        // })

        return () => {

            socket.off('room joined')
            socket.off('user connected')
            socket.off('new video')

            socket.emit('leave')
        }
    }, [socket, params.id, auth.user, history])

    const handleSubmit = async e => {
        e.preventDefault()

        if(isURL(search)) {

            try {

                // get video file from url
                const res = await ky.get(`/api/v1/video/extract?url=${encodeURIComponent(search)}`).json()

                // if no url
                if(!res.url) throw Error('no_url')

                let _video = {}

                // video url
                _video.url = Array.isArray(res.url) ? res.url : [res.url]
                // can we use video url or iframe instead
                _video.indirect = res.indirect ? true : false

                if(res.title) _video.title = res.title

                _video.hostname = new URL(_video.url[0]).hostname

                setVideo(_video)

                if(socket) {
                    console.log('sending video to room')
                    socket.emit('new video', _video)
                }

            } catch(err) {
                console.log(err)
            }

        } else {
            console.log('invalid url')
        }
    }

    return(
        <div ref={playerContainer} className={style.container}>

            <div className={style.playerBox}>
                <form onSubmit={handleSubmit}>
                    <TextInput
                        width='100%' height='40px'
                        className={style.input}
                        placeholder={l('typeVideoUrl')}

                        value={search}
                        onChange={({target: {value}}) => setSearch(value)}
                    />
                </form>

                <Player video={video} playerContainer={playerContainer} socket={socket} />
            </div>

        </div>
    )

}

export default Watch